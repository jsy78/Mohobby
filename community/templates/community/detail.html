{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}
{% block css %}
  <link rel="stylesheet" href="{% static 'css/community.css' %}">
{% endblock %}
{% block content %}
  <div class='container' style="margin-top: 5%; width:1000px">
    <div class='d-flex justify-content-between'>
      <h3 class='main_title align-self-center'>
        {{post.title}}
      </h3>
      <div>
        <img class='mb-2 user_img' id="profile_img" style="width:100px; height:100px;" src="{{ post.user.image.url }}" alt="{{ post.user.profile.image }}">
        {{post.user.username}}</div>
    </div>

    <div class='slideShow'>
      <ul class='slides list-unstyled'>
        {% for photo in post.photo_set.all %}
          <!-- 이미지 설정 -->
          <li><img src="{{ photo.image.url }}" alt="{{ photo.image.image }}" style="width: 800px; height: 500px;
        "></li>
        {% endfor %}
      </ul>
      <p class="controller">
        <!-- &lang: 왼쪽 방향 화살표 &rang: 오른쪽 방향 화살표 -->
        <span class="prev">&lang;</span>
        <span class="next">&rang;</span>
      </p>
    </div>
    <div>
      {{post.content}}
    </div>
    <div>
      {{post.created_at}}
    </div>
    <i class="bi bi-eye" style='margin-right:10px;'></i>
    {{post.hits}}
    <!-- 좋아요 -->
    {% if user.is_authenticated %}
      {% if request.user in post.like.all %}

        <button type="button" style="opacity: 0.8;" data-post-id='{{ post.pk }}' id='fav-btn' class="btn bi bi-heart-fill"></button>
      {% else %}

        <button type="button" id='fav-btn' data-post-id='{{ post.pk }}' style="opacity: 0.8;" class="btn bi bi-heart"></button>
      {% endif %}
      <span id='fav-count' class="text-center">{{ post.like.count }}</span>
    {% endif %}
    {% if request.user == post.user %}
      <div>
        <a href="{% url 'community:update' post.pk %}">
          <button class="btn">수정
          </button>
        </a>
      </div>
    {% endif %}
    <!-- 댓글 작성 -->
    <form data-post-id="{{ post.pk }}" action="{% url 'community:comments_create' post.pk %}" method="POST">
      {% csrf_token %}
      <div class='d-flex justify-content-center'>
        <div>
          {% if request.user.image %}
            <img class='user_img' id="profile_img" style="width:60px; height:60px;" src="{{ request.user.image.url }}" alt="{{ request.user.profile.image }}">
          {% else %}
            <img class='user_img' style="width:60px; height:60px;" src="{% static 'image/default_profile_img.jpg' %}">
          {% endif %}
          <input name="content" class='comment_input' type="text" placeholder="댓글 달기...">
        </div>
        <div class='d-flex align-items-center'>
          <input type="submit" class='comment_sbmit mx-2' value="등록">
        </div>
      </div>
    </form>
    <!-- 댓글 목록 -->
    <div>
      {% for comment in comments %}
        {% if comment.patrent_comment == NULL %}
          <div class='d-flex'>
            <div>
              {% if comment.user.image %}
                <img class='user_img' id="profile_img" style="width:50px; height:50px;" src="{{ comment.user.image.url }}" alt="{{ request.user.profile.image }}">
              {% else %}
                <img class='user_img' style="width:50px; height:50px;" src="{% static 'image/default_profile_img.jpg' %}">
              {% endif %}
            </div>
            <div>
              <div class='d-flex'>
                <strong>{{comment.user.username}}</strong>
                {% if request.user == comment.user %}
                  <div class='d-flex'>
                    <!-- 댓글 수정 -->
                    <button class='comment_update_btn' type="button" data-bs-toggle="collapse" data-bs-target="#comment{{comment.pk}}" aria-expanded="false" aria-controls="collapseExample">
                      <i class="bi bi-pencil comment_small_btn"></i>
                    </button>
                    <!-- 댓글 삭제 -->
                    <form action="{% url 'community:comments_delete' post.pk comment.pk %}" method="POST">
                      {% csrf_token %}
                      <button class='comment_update_btn' type="submit">
                        <i class="bi bi-x-lg comment_small_btn"></i>
                      </button>
                    </form>
                  </div>
                {% endif %}
              </div>
              <!-- 댓글 내용 -->
              <div class='comment_content'>{{comment.content}}
              </div>
              <div class='comment_small_text d-flex'>
                <div class='mx-1'>좋아요 0 개</div>
                <!-- 답글 달기 -->
                <div>
                  <a class="text-decoration-none mx-1" data-bs-toggle="collapse" style='color:#979AA0;' href="#collapse{{comment.pk}}">답글달기</a>
                </div>
              </div>
            </div>
          </div>
          <!-- 댓글 수정 form-->
          {% if request.user == comment.user %}
            <div class="collapse" id="comment{{comment.pk}}">
              <form action="{% url 'community:comments_update' post.pk comment.pk %}" method="POST" class="align-self-center">
                {% csrf_token %}
                {% if comment.user.image %}
                  <img class='user_img' id="profile_img" style="width:40px; height:40px;" src="{{ comment.user.image.url }}" alt="">
                {% else %}
                  <img class='user_img' style="width:40px; height:40px;" src="{% static 'image/default_profile_img.jpg' %}">
                {% endif %}
                <input name="content" class='comment_input' type="text" value='{{comment.content}}'>
                <input type="submit" class='comment_sbmit mx-2' value="수정">
              </form>
            </div>
          {% endif %}
          <!-- 대댓글 목록 -->
          <div class='recomment_list'>
            {% for recom in comment.recomment.all %}
              <div class='d-flex'>
                <div>
                  {% if comment.user.image %}
                    <img class='user_img' id="profile_img" style="width:40px; height:40px;" src="{{ recom.user.image.url }}" alt="">
                  {% else %}
                    <img class='user_img' style="width:40px; height:40px;" src="{% static 'image/default_profile_img.jpg' %}">
                  {% endif %}
                </div>
                <div>
                  <div class='d-flex'>
                    <div>{{ recom.user.username }}</div>
                    {% if request.user == recom.user %}
                      <div class='d-flex'>
                        <button class='comment_update_btn' type="button" data-bs-toggle="collapse" data-bs-target="#recomment{{recom.pk}}" aria-expanded="false" aria-controls="collapseExample">
                          <i class="bi bi-pencil comment_small_btn"></i>
                        </button>
                        <form action="{% url 'community:recomments_delete' post.pk recom.pk %}" method="POST">
                          {% csrf_token %}
                          <button class='comment_update_btn' type="submit">
                            <i class="bi bi-x-lg comment_small_btn"></i>
                          </button>
                        </form>
                      </div>
                    {% endif %}
                  </div>

                  <div>{{ recom.content}}</div>
                </div>
              </div>
              <!-- 대댓글 수정 -->
              {% if request.user == recom.user %}
                <div class="collapse recomment_list" id="recomment{{recom.pk}}">
                  <form action="{% url 'community:recomments_update' post.pk comment.pk recom.pk%}" method="POST">
                    {% csrf_token %}
                    {% if request.user.image %}
                      <img class='user_img' id="profile_img" style="width:40px; height:40px;" src="{{ request.user.image.url }}" alt="{{ request.user.profile.image }}">
                    {% else %}
                      <img class='user_img' style="width:40px; height:40px;" src="{% static 'image/default_profile_img.jpg' %}">
                    {% endif %}
                    <input name="content" class='comment_input' type="text" placeholder="답글 달기...">
                    <input type="submit" class='comment_sbmit mx-2' value="수정">
                  </form>
                </div>
              {% endif %}
            {% endfor %}
          </div>

        {% endif %}
        <!-- 답글 작성 form -->
        <div class="collapse recomment_list" id="collapse{{comment.pk}}">
          <form action="{% url 'community:recomments_create' post.pk comment.pk %}" method="POST">
            {% csrf_token %}
            {% if request.user.image %}
              <img class='user_img' id="profile_img" style="width:40px; height:40px;" src="{{ request.user.image.url }}" alt="{{ request.user.profile.image }}">
            {% else %}
              <img class='user_img' style="width:40px; height:40px;" src="{% static 'image/default_profile_img.jpg' %}">
            {% endif %}
            <input name="content" class='comment_input' type="text" placeholder="답글 달기...">
            <input type="submit" class='comment_sbmit mx-2' value="등록">
          </form>
        </div>
      {% endfor %}
    </div>

  </div>
  <script>
    const slides = document.querySelector('.slides'); //전체 이미지 슬라이드 컨테이너
    const slideImg = document.querySelectorAll('.slides li'); //모든 슬라이드들
    let currentIdx = 0; //현재 슬라이드 index 초기값 0
    const slideCount = slideImg.length; // 슬라이드 개수
    const prev = document.querySelector('.prev'); //이전 버튼
    const next = document.querySelector('.next'); //다음 버튼
    const slideWidth = 800; //한개의 슬라이드 넓이
    const slideMargin = 100; //슬라이드간의 margin 값
    //전체 슬라이드 컨테이너 넓이 설정
    slides.style.width = (slideWidth + slideMargin) * slideCount + 'px';

    console.log(slides)
    console.log(slideImg)

    function moveSlide(num) {
      slides.style.left = -num * 900 + 'px';
      currentIdx = num;
    }
    prev.addEventListener('click', function () {
      if (currentIdx !== 0) 
        moveSlide(currentIdx - 1);
      }
    );
    next.addEventListener('click', function () {
      if (currentIdx !== slideCount - 1) {
        moveSlide(currentIdx + 1);
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const favBtn = document.querySelector('#fav-btn')

    favBtn.addEventListener('click', function (event) {
      console.log(event.target.dataset)
      console.log(event.target.dataset.postId)

      axios({method: 'get', url: `/community/${event.target.dataset.postId}/like/`}).then(response => {
        if (response.data.is_likes === true) { // 좋아요 했으면
          event
            .target
            .classList
            .add('bi-heart-fill')
          event
            .target
            .classList
            .remove('bi-heart')
        } else {
          event
            .target
            .classList
            .add('bi-heart')
          event
            .target
            .classList
            .remove('bi-heart-fill')
        }
        const favCount = document.querySelector('#fav-count')
        favCount.innerText = response.data.likes_count
      })
    })
  </script>
{% endblock content%}
